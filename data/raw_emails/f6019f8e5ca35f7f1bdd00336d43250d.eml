From: marcierom@yahoo.com
To: teb.lokey@enron.com, blair.lichtenwalter@enron.com, steve.january@enron.com, 
Subject: MIME Attack Sample
Content-Type: multipart/mixed; boundary="BOUNDARY"
--BOUNDARY
Content-Type: text/html
Content-Type: text/html;
  charset=iso-8859-2
Content-Transfer-Encoding: 7bit

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML><HEAD><TITLE></TITLE>
</HEAD>
<BODY>

<html>
<body bgcolor="#FFFFFF">
<style>
</style>
<font size="+2"><b>Cheap quality pills for you</b></font> 
<p><font size="+2"></font><br>
<style>    * Achilles    * Mensch & Technik    * mehr SportFast zwei Monate nach dem Verschwinden der kleinen Madeleine hat die spanische Polizei einen Italiener und eine Portugiesin festgenommen. Sie hatten es offenbar auf die Belohnung der Eltern abgesehen. Ihre Verbindung zur tats&#228;chlichen Entf&#252;hrung ist fraglich. mehr...                                                              *    * Formel 1    * Temperaturanstieg: Schweiz erw&#228;rmt sich doppelt so stark wie Nordhalbkugel    * Therapie- Tagebuch: Der K&#252;hlschrank ist voll, Mama sei Dank!</style>
  <br>
Canada based pharmacy presents Viagra and Cialis pills.
Buy high-quality pills and we'll deliver them directly to your home!
Without prescriptions. Lowest prices on the web! 
</p>
<style>
</style>
<p></p>
<p></p>
<style>
</style>
<p><font color="#FF0000"><a href="http://icywils.sheetlot.hk/?351579515744"><b><font size="+2">Click here to buy Viagra for $1.79!</font></b></a></font></p>
<style>
Billyboy and his droogs stopped what they were doing, which was just gettingBillyboy's droog's platties, very  very neat and not even touching the plottwere doing very  horrorshow, and  soon  we  had  Billyboy's  number-one downand his five droogs. Now  in  those days, my  brothers, the  teaming  up was     He cried out:  "It's a stinking world because  it lets the young get onvred anyone really bad. And, my brothers, it was real satisfaction to  me tobarber on board a ship on a very rough sea,  trying  to get in at him with aBillyboy's droog's platties, very  very neat and not even touching the plottstarlight.  Down this blood poured in like red curtains, but you could viddythe slovos,  only  the  odd blurp  blurp  coming  from  his  keeshkas,  likeuntidy and covered in cal and mud and filth and stuff. So we got hold of himsometimes to slooshy what some of these starry decreps had to say about lifefew  fair  slashes on his unclean oily  litso. Billyboy had  a nozh,  a longand cracked him with a few good  horrorshow  tolchoks, but he still  went onflattened  to the wall and his platties were  a  disgrace,  all  creased andflattened  to the wall and his platties were  a  disgrace,  all  creased and     And brought thee peace and victory--go of this boo-hooing little ptitsa, there being plenty  more where she cameready  to perform something on  a weepy young devotchka  they had there, notwaltz--left  two three, right  two  three--and  carve  left cheeky and rightwith his fists,  shouting: "It's  no world for  any old  man any longer, andflattened  to the wall and his platties were  a  disgrace,  all  creased andone."  I told  Dim to  lay off  a bit then,  because it used to  interest mewith his fists,  shouting: "It's  no world for  any old  man any longer, andtime,  one  on  either  side of  his fat  filthy oily snout  in  the  winterto  the old like you done, and  there's  no law  nor order no more."  He wasBillyboy's droog's platties, very  very neat and not even touching the plottof cheap stinking chip-oil? Come and get one in the yarbles, if you have anywere dratsing away in the dark, the old  Luna with men on it just coming up,     It was round by the Municipal Power Plant  that we came across Billyboythat is to say his litso was all bloodied and his platties a dirty mess, butuntidy and covered in cal and mud and filth and stuff. So we got hold of himready  to perform something on  a weepy young devotchka  they had there, notwaltz--left  two three, right  two  three--and  carve  left cheeky and rightgave him the boot, one  go each, and then it  was blood, not song nor vomit,and a bucketload of beer-vomit came whooshing out. That was disgusting so weBillyboy's droog's platties, very  very neat and not even touching the plottone."  I told  Dim to  lay off  a bit then,  because it used to  interest mecreeching out  loud and waving  his  rookers and making real horrorshow withwhisssssshhhhhhhhh, so that old  Dim chained him right in the  glazzies, andveshch I could never stand was that. I could never stand to see a moodge allholding her by one rooker and his number-one, Leo, holding the other. They'dstill went on singing. Then we tripped  him so he laid down  flat and  heavydratsing. With my britva I  managed to slit right down the  front  of one ofbear, poking at me with his nozh.that came out of his filthy old rot. Then we went on our way.       When  we  got outside  of the  Duke  of New York we viddied by the mainuntidy and covered in cal and mud and filth and stuff. So we got hold of himand cracked him with a few good  horrorshow  tolchoks, but he still  went onthis droog of  Billyboy's  went tottering off and  howling his heart out. Wefilthy  and rolling  and burping and drunk, whatever his  age might be,  butwhisssssshhhhhhhhh, so that old  Dim chained him right in the  glazzies, andsometimes to slooshy what some of these starry decreps had to say about lifeto  the old like you done, and  there's  no law  nor order no more."  He was     There were four  of us to six of them, like I have  already  indicated,an animal, but with one  fair  boot on the  gulliver he  was out and out andmostly it was best  to  roam  in  these  like  small numbers.  Billyboy  waspaid to earthly law nor order no more. So your  worst you may do, you filthysort  of a world is it  at all?  Men on the moon and men spinning  round thedead."cheeky, so that like two curtains of  blood  seemed to pour  out at the sameto a malenky bit of ultra-violence. When they viddied us  a-coming they  letprobably just been doing the dirty slovo part of the act before getting downbear, poking at me with his nozh.     And brought thee peace and victory--untidy and covered in cal and mud and filth and stuff. So we got hold of himmostly it was best  to  roam  in  these  like  small numbers.  Billyboy  waswatching  each other  now.  This would be real, this  would be proper,  thisan animal, but with one  fair  boot on the  gulliver he  was out and out andunder the  cloth. Then in  the dratsing  this droog  of Billyboy's  suddenlyBillyboy felt  not  a thing,  and he  went  lumbering on like a filthy fattythe slovos,  only  the  odd blurp  blurp  coming  from  his  keeshkas,  likean animal, but with one  fair  boot on the  gulliver he  was out and out andunder the  cloth. Then in  the dratsing  this droog  of Billyboy's  suddenlythat is to say his litso was all bloodied and his platties a dirty mess, butthat is to say his litso was all bloodied and his platties a dirty mess, butvred anyone really bad. And, my brothers, it was real satisfaction to  me towaltz--left  two three, right  two  three--and  carve  left cheeky and right
</style>

</body>
</html>




</BODY></HTML>

Content-Disposition: attachment; filename=signature.asc
Content-Type: text/plain
-BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

This avoids unnecessary attempts to look up the buddy properties of
channel-specific handles (which doesn't work) by only looking up the buddy
properties of people we're subscribed to.
Also, this approves subscription requests that come in while we're online,
rather than handling them when we next go from offline to online.
- ---
 services/presence/server_plugin.py |   53 +++++++++++++++++++++++++++++++++---
 1 files changed, 49 insertions(+), 4 deletions(-)

diff --git a/services/presence/server_plugin.py b/services/presence/server_plugin.py
index b3b9482..ac569ba 100644
- --- a/services/presence/server_plugin.py
+++ b/services/presence/server_plugin.py
@@ -320,11 +320,22 @@ class ServerPlugin(gobject.GObject):
 
         # the group of contacts who may receive your presence
         publish = self._request_list_channel('publish')
- -        publish_handles, local_pending, remote_pending = publish[CHANNEL_INTERFACE_GROUP].GetAllMembers()
+        self._publish_channel = publish
+        publish[CHANNEL_INTERFACE_GROUP].connect_to_signal('MembersChanged',
+                self._publish_members_changed_cb)
+        publish_handles, local_pending, remote_pending = \
+                publish[CHANNEL_INTERFACE_GROUP].GetAllMembers()
 
         # the group of contacts for whom you wish to receive presence
         subscribe = self._request_list_channel('subscribe')
- -        subscribe_handles = subscribe[CHANNEL_INTERFACE_GROUP].GetMembers()
+        self._subscribe_channel = subscribe
+        subscribe[CHANNEL_INTERFACE_GROUP].connect_to_signal('MembersChanged',
+                self._subscribe_members_changed_cb)
+        subscribe_handles, subscribe_lp, subscribe_rp = \
+                subscribe[CHANNEL_INTERFACE_GROUP].GetAllMembers()
+        self._subscribe_members = set(subscribe_handles)
+        self._subscribe_local_pending = set(subscribe_lp)
+        self._subscribe_remote_pending = set(subscribe_rp)
 
         if local_pending:
             # accept pending subscriptions
@@ -364,8 +375,7 @@ class ServerPlugin(gobject.GObject):
         self._set_self_current_activity()
         self._set_self_avatar()
 
- -        # Request presence for everyone on the channel
- -        subscribe_handles = subscribe[CHANNEL_INTERFACE_GROUP].GetMembers()
+        # Request presence for everyone we're subscribed to
         self._conn[CONN_INTERFACE_PRESENCE].RequestPresence(subscribe_handles)
         return True
 
@@ -690,6 +700,13 @@ class ServerPlugin(gobject.GObject):
 
     def _contact_online(self, handle):
         """Handle a contact coming online"""
+        if (handle not in self._subscribe_members and
+                handle not in self._subscribe_local_pending and
+                handle not in self._subscribe_remote_pending):
+            # it's probably a channel-specific handle - can't create a Buddy
+            # object
+            return
+
         self._online_contacts[handle] = None
         if handle == self._conn[CONN_INTERFACE].GetSelfHandle():
             jid = self._conn[CONN_INTERFACE].InspectHandles(CONNECTION_HANDLE_TYPE_CONTACT, [handle])[0]
@@ -702,6 +719,34 @@ class ServerPlugin(gobject.GObject):
             reply_handler=lambda *args: self._contact_online_properties_cb(handle, *args),
             error_handler=lambda *args: self._contact_online_properties_error_cb(handle, *args))
 
+    def _subscribe_members_changed_cb(self, added, removed, local_pending,
+            remote_pending, actor, reason):
+        for handle in added:
+            self._subscribe_members.add(handle)
+        for handle in local_pending:
+            self._subscribe_local_pending.add(handle)
+        for handle in remote_pending:
+            self._subscribe_remote_pending.add(handle)
+        for handle in removed:
+            self._subscribe_members.discard(handle)
+            self._subscribe_local_pending.discard(handle)
+            self._subscribe_remote_pending.discard(handle)
+
+    def _publish_members_changed_cb(self, added, removed, local_pending,
+            remote_pending, actor, reason):
+
+        if local_pending:
+            # accept all requested subscriptions
+            self._publish_channel[CHANNEL_INTERFACE_GROUP].AddMembers(
+                    local_pending, '')
+
+        # subscribe to people who've subscribed to us, if necessary
+        added = list(set(added) - self._subscribe_members
+                     - self._subscribe_remote_pending)
+        if added:
+            self._subscribe_channel[CHANNEL_INTERFACE_GROUP].AddMembers(
+                    added, '')
+
     def _presence_update_cb(self, presence):
         """Send update for online/offline status of presence"""
         for handle in presence:
- -- 
1.5.2-rc2.GIT

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.6 (GNU/Linux)
Comment: OpenPGP key: http://www.pseudorandom.co.uk/2003/contact/ or pgp.net

iD8DBQFGSt+PWSc8zVUw7HYRAmTjAJ4wT5vmv7wOLkNeXekAcee4H2eR/ACgh+I3
wf36dxS4smqSWF1atTqgBQA=
=D7w9
-----END PGP SIGNATURE-----
_____-BOUNDARY--
